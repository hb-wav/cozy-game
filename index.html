<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cozy Question Game</title>
  <style>
    :root{
      --bg1:#fff7fb;
      --bg2:#fffef6;
      --card:#ffffffd6;
      --ink:#2b2b2b;
      --muted:#6b6b6b;
      --accent:#ff6fae;
      --accent2:#ffb84d;
      --mint:#2bb673;
      --shadow: 0 12px 34px rgba(0,0,0,.08);
      --radius: 24px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--ink);
      min-height:100svh;
      background:
        radial-gradient(900px 600px at 10% 10%, var(--bg2), transparent 60%),
        radial-gradient(900px 600px at 90% 30%, #ffe3f1, transparent 55%),
        radial-gradient(900px 600px at 40% 90%, #fff1d6, transparent 55%),
        linear-gradient(180deg, var(--bg1), #ffffff);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      overflow-x:hidden;
    }

    /* Subtle drifting glow (softened so it won't fight your text) */
    .bg-drift{
      position: fixed;
      inset: -140px;
      pointer-events:none;
      opacity:.18;
      filter: blur(44px);
      background:
        radial-gradient(circle at 20% 25%, rgba(255,111,174,.35), transparent 35%),
        radial-gradient(circle at 75% 30%, rgba(255,184,77,.35), transparent 35%),
        radial-gradient(circle at 45% 80%, rgba(43,182,115,.22), transparent 40%);
      animation: drift 16s ease-in-out infinite alternate;
    }
    @keyframes drift{
      from{ transform: translate3d(-10px, -6px, 0) scale(1); }
      to{ transform: translate3d(12px, 10px, 0) scale(1.02); }
    }

    .app{
      width:min(560px, 100%);
      display:flex;
      flex-direction:column;
      gap:14px;
      position:relative;
      z-index:1;
    }

    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:12px 12px;
      background:var(--card);
      border:1px solid rgba(255,111,174,.18);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    .title{
      display:flex; flex-direction:column; gap:2px;
      line-height:1.1;
    }
    .title .h1{
      font-weight:950;
      letter-spacing:.2px;
      font-size:14px;
    }
    .title .sub{
      font-size:12px;
      color:var(--muted);
    }

    .pillrow{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
      color:var(--ink);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      display:flex; gap:6px; align-items:center;
      box-shadow: 0 6px 14px rgba(0,0,0,.05);
    }
    .pill strong{ font-weight:950; }

    .card{
      background:var(--card);
      border:1px solid rgba(0,0,0,.06);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
      backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
    }

    /* POP LAYER for tiny emoji pops */
    .poplayer{
      position:absolute;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index: 1;
    }
    .emopop{
      position:absolute;
      font-size:18px;
      opacity:0;
      transform: translate(-50%, -50%) scale(.9);
      animation: popFloat 650ms ease-out forwards;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.08));
    }
    @keyframes popFloat{
      0%{ opacity:0; transform: translate(-50%, -50%) scale(.9); }
      20%{ opacity:1; transform: translate(-50%, -56%) scale(1.06); }
      100%{ opacity:0; transform: translate(-50%, -84%) scale(.95); }
    }

    /* Candle mascot ‚Äî sits in top-right without overlapping question */
    .mascot{
      position:absolute;
      top:12px;
      right:12px;
      width:70px;
      height:70px;
      border-radius:22px;
      background:#fff;
      border:1px solid rgba(0,0,0,.07);
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      z-index: 2;
    }
    .mascot-inner{
      width:56px; height:56px;
      position:relative;
      transform-origin:center;
      animation: idleBob 3.1s ease-in-out infinite;
    }
    @keyframes idleBob{
      0%,100%{ transform: translateY(0); }
      50%{ transform: translateY(-3px); }
    }
    .candle{
      position:absolute;
      left:50%;
      bottom:8px;
      transform: translateX(-50%);
      width:30px;
      height:30px;
      border-radius:12px 12px 14px 14px;
      background: linear-gradient(180deg, #ffffff, #ffe8f3);
      border:1px solid rgba(0,0,0,.08);
      box-shadow: inset 0 -6px 10px rgba(0,0,0,.04);
    }
    .candle:before{
      content:"";
      position:absolute;
      left:50%;
      top:-8px;
      transform: translateX(-50%);
      width:8px;
      height:10px;
      border-radius:6px;
      background: rgba(0,0,0,.12);
    }

    .face{
      position:absolute;
      left:50%;
      top:10px;
      transform: translateX(-50%);
      width:22px;
      height:14px;
    }
    .eye{
      position:absolute;
      top:2px;
      width:4px; height:4px;
      border-radius:999px;
      background: rgba(0,0,0,.55);
    }
    .eye.left{ left:4px; }
    .eye.right{ right:4px; }
    .mouth{
      position:absolute;
      left:50%;
      bottom:0px;
      transform: translateX(-50%);
      width:10px;
      height:6px;
      border:2px solid rgba(0,0,0,.55);
      border-top:0;
      border-left:0;
      border-right:0;
      border-radius:0 0 10px 10px;
      opacity:.9;
    }
    .blush{
      position:absolute;
      top:6px;
      width:7px; height:5px;
      border-radius:999px;
      background: rgba(255,111,174,.30);
      opacity:0;
      transition: opacity .18s ease;
    }
    .blush.left{ left:-2px; }
    .blush.right{ right:-2px; }

    .flame{
      position:absolute;
      left:50%;
      bottom:40px;
      transform: translateX(-50%);
      width:18px;
      height:26px;
      border-radius: 999px;
      background: radial-gradient(circle at 35% 35%, #fff6d6 0 35%, #ffd27a 40% 70%, #ff99c8 71% 100%);
      box-shadow: 0 0 8px rgba(255,184,77,.35);
      animation: flameFlicker 1.1s ease-in-out infinite;
      transform-origin: 50% 100%;
    }
    @keyframes flameFlicker{
      0%,100%{ transform: translateX(-50%) rotate(-2deg) scale(1); }
      50%{ transform: translateX(-50%) rotate(2deg) scale(1.02); }
    }

    /* mascot moods */
    .mascot.deep .flame{ box-shadow: 0 0 10px rgba(43,182,115,.28); filter: saturate(.95); }
    .mascot.flirty .blush{ opacity: 1; }
    .mascot.light .flame{ box-shadow: 0 0 8px rgba(255,184,77,.35); }
    .mascot.spicy .flame{ filter: saturate(1.15) contrast(1.03); box-shadow: 0 0 12px rgba(255,111,174,.35); }
    .mascot.pop .mascot-inner{ animation: pop 240ms ease-out 1; }
    @keyframes pop{
      0%{ transform: translateY(0) scale(1); }
      60%{ transform: translateY(-2px) scale(1.05); }
      100%{ transform: translateY(0) scale(1); }
    }

    .kicker{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
      padding-right:84px; /* critical: keeps question area clear of mascot */
      position: relative;
      z-index: 3;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      font-weight:950;
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(255,111,174,.18);
    }
    .badge .dot{
      width:10px; height:10px; border-radius:50%;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow:0 0 0 4px rgba(255,111,174,.10);
    }
    .points{
      font-weight:950;
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
    }

    .preface{
      font-size:12px;
      color:var(--muted);
      margin-top:0px;
      line-height:1.35;
      position: relative;
      z-index: 3;
      padding-right: 84px; /* also avoid mascot overlap */
    }

    .qtext{
      font-size:22px;
      font-weight:950;
      letter-spacing:.2px;
      line-height:1.2;
      margin: 10px 0 10px;
      position: relative;
      z-index: 3;
      padding-right: 84px; /* also avoid mascot overlap */
    }

    .meta{
      display:flex; gap:8px; flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
      margin:12px 0 14px;
      position: relative;
      z-index: 3;
      padding-right: 84px;
    }
    .tag{
      padding:6px 10px;
      border-radius:999px;
      border:1px dashed rgba(0,0,0,.15);
      background:#fff;
    }

    .btnrow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:6px;
      position: relative;
      z-index: 3;
    }
    button{
      appearance:none;
      border:0;
      cursor:pointer;
      border-radius:20px;
      padding:14px 12px;
      font-weight:950;
      font-size:14px;
      box-shadow: 0 10px 20px rgba(0,0,0,.08);
      transition: transform .06s ease, filter .06s ease;
    }
    button:active{ transform: translateY(1px) scale(.99); filter: brightness(.98); }
    .btnH{
      background: linear-gradient(135deg, #ff6fae, #ff99c8);
      color:#fff;
    }
    .btnB{
      background: linear-gradient(135deg, #ffb84d, #ffd27a);
      color:#2b2b2b;
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-top:10px;
      position: relative;
      z-index: 3;
    }
    .ghost{
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      color:var(--ink);
    }
    .next{
      background: linear-gradient(135deg, #2bb673, #75d39b);
      color:#fff;
    }

    .footer{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      padding:12px 12px;
      background:var(--card);
      border:1px solid rgba(0,0,0,.06);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:12px;
      color:var(--muted);
      user-select:none;
    }
    .switch{
      width:46px; height:28px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(0,0,0,.12);
      position:relative;
      box-shadow: inset 0 2px 6px rgba(0,0,0,.06);
      cursor:pointer;
      flex:0 0 auto;
    }
    .knob{
      position:absolute;
      top:3px; left:3px;
      width:22px; height:22px;
      border-radius:999px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      transition:left .16s ease;
      box-shadow:0 8px 16px rgba(0,0,0,.12);
    }
    .switch.on .knob{ left:21px; }

    .tiny{
      font-size:11px;
      color:var(--muted);
      line-height:1.35;
    }
    .danger{
      color:#b00020;
      font-weight:900;
      text-decoration:underline;
      cursor:pointer;
    }
  </style>
</head>

<body>
  <div class="bg-drift"></div>

  <div class="app">
    <div class="topbar">
      <div class="title">
        <div class="h1">Cozy Question Game</div>
        <div class="sub">sweet ‚Ä¢ flirty ‚Ä¢ kind ‚Ä¢ tap to score</div>
      </div>
      <div class="pillrow">
        <div class="pill">Holly: <strong id="scoreH">0</strong></div>
        <div class="pill">Bailey: <strong id="scoreB">0</strong></div>
      </div>
    </div>

    <div class="card" id="card">
      <div class="poplayer" id="poplayer"></div>

      <div class="mascot light" id="mascot" aria-hidden="true">
        <div class="mascot-inner">
          <div class="flame"></div>
          <div class="candle">
            <div class="face">
              <div class="eye left"></div>
              <div class="eye right"></div>
              <div class="blush left"></div>
              <div class="blush right"></div>
              <div class="mouth"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="kicker">
        <div class="badge"><span class="dot"></span> <span id="qIndex">Ready?</span></div>
        <div class="points" id="pointsPill">‚Äî</div>
      </div>

      <div class="preface" id="preface">Keep it light and sweet.</div>
      <div class="qtext" id="qText">Tap ‚ÄúNext‚Äù to start.</div>

      <div class="meta" id="meta"></div>

      <div class="btnrow">
        <button class="btnH" id="addH">+ points to Holly</button>
        <button class="btnB" id="addB">+ points to Bailey</button>
      </div>

      <div class="controls">
        <button class="ghost" id="skip">Skip</button>
        <button class="ghost" id="undo">Undo</button>
        <button class="next" id="next">Next</button>
      </div>

      <div class="tiny" style="margin-top:10px;">
        If something feels too heavy, skip it. üïØÔ∏è
      </div>
    </div>

    <div class="footer">
      <div class="toggle">
        <div class="switch" id="spiceSwitch" role="switch" aria-checked="false" tabindex="0">
          <div class="knob"></div>
        </div>
        <div>
          <div><strong id="spiceLabel">Cozy Only</strong></div>
          <div class="tiny">Toggle on = include everything</div>
        </div>
      </div>

      <div class="tiny">
        <span id="progress">0 / 0 used</span> ¬∑
        <span class="danger" id="resetAll">reset</span>
      </div>
    </div>
  </div>

  <script>
    // tags:
    // - "spicy": filtered out when Cozy Only
    // - "deep": heavier vulnerability
    // - "light": playful
    // - "flirty": sweet chemistry
    const QUESTIONS = [
      { q:"What‚Äôs your biggest pet peeve?", pts:5, tags:["light"] },
      { q:"What was the worst date you‚Äôve ever been on?", pts:10, tags:["light"] },
      { q:"What‚Äôs your love language?", pts:5, tags:["light"] },
      { q:"What do you think your most attractive feature is and why?", pts:10, tags:["flirty"] },
      { q:"What does a good pace when dating look like for you?", pts:15, tags:["deep"] },
      { q:"What was your longest relationship?", pts:10, tags:["deep"] },
      { q:"Are you a morning person or night owl?", pts:2, tags:["light"] },
      { q:"What‚Äôs one thing you want to accomplish this year?", pts:5, tags:["light"] },
      { q:"If you could travel anywhere, where would you go?", pts:5, tags:["light"] },
      { q:"What‚Äôs the best concert you‚Äôve ever been to?", pts:5, tags:["light"] },
      { q:"What‚Äôs the best piece of advice you ever received?", pts:10, tags:["deep"] },
      { q:"Ass or titties?", pts:2, tags:["spicy"] },
      { q:"What‚Äôs your biggest fear?", pts:10, tags:["deep"] },
      { q:"Who‚Äôs someone you admire and why?", pts:5, tags:["deep"] },
      { q:"What‚Äôs one celebrity you‚Äôd want to meet and why?", pts:5, tags:["light"] },
      { q:"What are you naturally talented at?", pts:5, tags:["light"] },
      { q:"If you could change careers, what would you choose?", pts:10, tags:["deep"] },
      { q:"What‚Äôs your comfort show or movie?", pts:2, tags:["light"] },
      { q:"How do you like to be cared for when you‚Äôre sick?", pts:10, tags:["deep"] },
      { q:"If you could visit any time period, which and why?", pts:5, tags:["light"] },
      { q:"How‚Äôs your driving?", pts:2, tags:["light"] },
      { q:"Did you ever sneak out as a kid?", pts:5, tags:["light"] },
      { q:"What‚Äôs a hard dealbreaker for you?", pts:15, tags:["deep"] },
      { q:"What‚Äôs your worst habit?", pts:15, tags:["deep"] },
      { q:"How would your friends describe you?", pts:10, tags:["deep"] },
      { q:"How would you describe your sense of humor?", pts:10, tags:["light"] },
      { q:"What are some things that make you angry?", pts:10, tags:["deep"] },
      { q:"What is something that warms your heart?", pts:5, tags:["deep"] },
      { q:"What‚Äôs the worst job you‚Äôve ever had?", pts:5, tags:["light"] },
      { q:"What‚Äôs one skill you want to learn?", pts:5, tags:["light"] },
      { q:"If you could have any superpower, what would it be and why?", pts:2, tags:["light"] },
      { q:"What‚Äôs your walk up song?", pts:2, tags:["light"] },
      { q:"What‚Äôs one song that speaks your truth?", pts:10, tags:["deep"] },
      { q:"What do you find attractive?", pts:5, tags:["flirty"] },
      { q:"What‚Äôs your ideal date night look like?", pts:10, tags:["flirty"] },
      { q:"What‚Äôs your biggest secret?", pts:25, tags:["deep"] },
      { q:"What‚Äôs your immediate skip song?", pts:2, tags:["light"] },
      { q:"What‚Äôs your guilty pleasure?", pts:5, tags:["light"] },
      { q:"Are you a city slicker or country bumpkin?", pts:2, tags:["light"] },
      { q:"What‚Äôs your comfort food?", pts:5, tags:["light"] },
      { q:"What‚Äôs your favorite restaurant or meal?", pts:5, tags:["light"] },
      { q:"Top, bottom, or switch? Elaborate", pts:15, tags:["spicy"] },
      { q:"Do you like to drive or be a passenger?", pts:2, tags:["light"] },
      { q:"Is there any food you hate?", pts:5, tags:["light"] },
      { q:"Do you like road trips?", pts:2, tags:["light"] },
      { q:"What does your ideal relationship look like?", pts:10, tags:["deep"] },
      { q:"What do you find annoying?", pts:10, tags:["deep"] },
      { q:"What‚Äôs the worst concert you‚Äôve ever been to?", pts:5, tags:["light"] },
      { q:"If you were an animal what kind of animal would you be and why?", pts:5, tags:["light"] },
      { q:"What‚Äôs your most prized possession?", pts:10, tags:["deep"] },
      { q:"Do you like to cuddle? Are you big spoon or little spoon?", pts:5, tags:["flirty"] },
      { q:"How do you feel about PDA?", pts:5, tags:["flirty"] },
      { q:"What does support look like for you?", pts:10, tags:["deep"] },
      { q:"What‚Äôs one fun fact about you?", pts:5, tags:["light"] },
      { q:"What‚Äôs the craziest injury you‚Äôve ever sustained?", pts:10, tags:["light"] },
      { q:"What‚Äôs your favorite flavor of ice cream?", pts:2, tags:["light"] },
      { q:"Sweet or savory?", pts:2, tags:["light"] },
      { q:"What‚Äôs the best vacation or trip you‚Äôve ever taken?", pts:5, tags:["light"] },
      { q:"What‚Äôs your favorite memory?", pts:10, tags:["deep"] },
      { q:"Do you prefer gifts or experiences?", pts:2, tags:["light"] },
      { q:"What are some of your most important values?", pts:15, tags:["deep"] },
      { q:"What‚Äôs one thing you‚Äôve always wanted to try but been too scared to?", pts:10, tags:["deep"] },
      { q:"What would your drag name be?", pts:2, tags:["light"] },
      { q:"Do you like to be led or do you like to take charge?", pts:10, tags:["spicy"] },
      { q:"What do you think is your best quality?", pts:5, tags:["deep"] },
      { q:"What‚Äôs one thing you want someone to know before dating you?", pts:15, tags:["deep"] },
      { q:"What‚Äôs your favorite sport to watch or play? Did you ever play any sports growing up?", pts:2, tags:["light"] },
      { q:"Have you ever met anyone famous? Who and how? Were they cool?", pts:5, tags:["light"] },
      { q:"What‚Äôs your go to porn category to watch?", pts:25, tags:["spicy"] },
      { q:"What‚Äôs something that stresses you out?", pts:15, tags:["deep"] },
      { q:"What‚Äôs something you‚Äôre super thankful for?", pts:10, tags:["deep"] },
      { q:"What does a typical day look like for you?", pts:5, tags:["light"] },
      { q:"What‚Äôs something you want to implement into your life?", pts:10, tags:["deep"] },
      { q:"Who‚Äôs the first person you would want to introduce to someone you were dating and why?", pts:10, tags:["deep"] },
      { q:"Why did your last relationship end?", pts:25, tags:["deep"] },
      { q:"Are you talking to anyone else?", pts:5, tags:["deep"] },
      { q:"What‚Äôs the best birthday you‚Äôve ever had?", pts:10, tags:["light"] },
      { q:"Beach or mountains?", pts:2, tags:["light"] },
      { q:"What is something that‚Äôs super important to you?", pts:15, tags:["deep"] },
      { q:"What‚Äôs your most meaningful tattoo?", pts:5, tags:["deep"] },
      { q:"Have you ever hit a rock bottom before? What was it?", pts:25, tags:["deep"] },
      { q:"What‚Äôs one thing you‚Äôve learned from life so far?", pts:15, tags:["deep"] },
      { q:"What‚Äôs your favorite conspiracy theory?", pts:2, tags:["light"] },
      { q:"Who is your celebrity crush?", pts:5, tags:["light"] },
      { q:"What‚Äôs one thing you would tell your younger self?", pts:10, tags:["deep"] },
      { q:"What‚Äôs one thing you struggle with?", pts:15, tags:["deep"] },
      { q:"If you had 3 wishes what would they be?", pts:10, tags:["light"] },
      { q:"What‚Äôs your favorite pick up line?", pts:2, tags:["flirty"] },
      { q:"What would you say your biggest accomplishment is?", pts:10, tags:["deep"] },
      { q:"What‚Äôs your most embarrassing moment?", pts:15, tags:["light"] },
      { q:"What grosses you out?", pts:10, tags:["light"] },
      { q:"If you were gifted a million dollars what would you do with it?", pts:15, tags:["light"] },
      { q:"What‚Äôs one question you really want to ask me?", pts:15, tags:["deep"] },
      { q:"What‚Äôs your biggest turn on?", pts:15, tags:["spicy"] },
      { q:"Whats your biggest turn off?", pts:15, tags:["spicy"] },
      { q:"What‚Äôs your biggest unpopular opinion?", pts:10, tags:["light"] },
      { q:"Who‚Äôs your favorite person in the world? Why?", pts:5, tags:["deep"] },
      { q:"What‚Äôs one thing you can‚Äôt live without?", pts:5, tags:["light"] },
      { q:"Where do you see yourself in 5 years?", pts:15, tags:["deep"] },
      { q:"What do you like most about me?", pts:15, tags:["flirty"] },
    ];

    const LS_KEY = "cozy_question_game_fixed_v3";

    const els = {
      scoreH: document.getElementById("scoreH"),
      scoreB: document.getElementById("scoreB"),
      qIndex: document.getElementById("qIndex"),
      qText: document.getElementById("qText"),
      pointsPill: document.getElementById("pointsPill"),
      meta: document.getElementById("meta"),
      preface: document.getElementById("preface"),
      addH: document.getElementById("addH"),
      addB: document.getElementById("addB"),
      next: document.getElementById("next"),
      skip: document.getElementById("skip"),
      undo: document.getElementById("undo"),
      spiceSwitch: document.getElementById("spiceSwitch"),
      spiceLabel: document.getElementById("spiceLabel"),
      progress: document.getElementById("progress"),
      resetAll: document.getElementById("resetAll"),
      mascot: document.getElementById("mascot"),
      poplayer: document.getElementById("poplayer"),
    };

    const defaultState = {
      scoreH: 0,
      scoreB: 0,
      includeSpicy: false,
      usedIds: [],
      currentId: null,
      lastAction: null, // { who:"H"/"B", pts:number, qId:number }
    };

    let state = loadState();

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return structuredClone(defaultState);
        const parsed = JSON.parse(raw);
        return { ...structuredClone(defaultState), ...parsed };
      }catch{
        return structuredClone(defaultState);
      }
    }

    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      renderScores();
      renderProgress();
    }

    function filteredQuestions(){
      return QUESTIONS
        .map((x, idx) => ({ ...x, id: idx }))
        .filter(x => state.includeSpicy ? true : !x.tags.includes("spicy"));
    }

    function currentQuestion(){
      if(state.currentId === null) return null;
      const q = QUESTIONS[state.currentId];
      return { ...q, id: state.currentId };
    }

    function pickNext(){
      const pool = filteredQuestions();
      const used = new Set(state.usedIds);
      const remaining = pool.filter(q => !used.has(q.id));

      if(remaining.length === 0){
        state.usedIds = [];
        state.currentId = null;
        state.lastAction = null;
        saveState();
        return pickNext();
      }

      const next = remaining[Math.floor(Math.random() * remaining.length)];
      state.currentId = next.id;
      state.usedIds.push(next.id);
      state.lastAction = null;
      saveState();
      renderCard(true);
    }

    function award(who){
      const q = currentQuestion();
      if(!q) return;
      const pts = q.pts;

      if(who === "H") state.scoreH += pts;
      if(who === "B") state.scoreB += pts;

      state.lastAction = { who, pts, qId: q.id };
      saveState();

      mascotPop();
      emojiPop(who);
    }

    function undo(){
      const a = state.lastAction;
      if(!a) return;
      if(a.who === "H") state.scoreH = Math.max(0, state.scoreH - a.pts);
      if(a.who === "B") state.scoreB = Math.max(0, state.scoreB - a.pts);
      state.lastAction = null;
      saveState();
      emojiPop("undo");
    }

    function renderScores(){
      els.scoreH.textContent = state.scoreH;
      els.scoreB.textContent = state.scoreB;
    }

    function renderProgress(){
      const pool = filteredQuestions();
      const used = state.usedIds.length;
      els.progress.textContent = `${used} / ${pool.length} used`;
    }

    function renderSpice(){
      els.spiceSwitch.classList.toggle("on", state.includeSpicy);
      els.spiceSwitch.setAttribute("aria-checked", state.includeSpicy ? "true" : "false");
      els.spiceLabel.textContent = state.includeSpicy ? "All Questions" : "Cozy Only";
    }

    function setMascotMood(tags){
      els.mascot.classList.remove("light","flirty","deep","spicy");
      if(tags.includes("spicy")) els.mascot.classList.add("spicy");
      else if(tags.includes("deep")) els.mascot.classList.add("deep");
      else if(tags.includes("flirty")) els.mascot.classList.add("flirty");
      else els.mascot.classList.add("light");
    }

    function prefaceFor(tags){
      if(tags.includes("spicy")) return "Only if it‚Äôs the vibe.";
      if(tags.includes("deep")) return "Slow is good. Take your time.";
      if(tags.includes("flirty")) return "A little blush moment.";
      return "Keep it light and sweet.";
    }

    function tagEmoji(t){
      if(t === "flirty") return "‚≠ê";
      if(t === "deep") return "ü´∂";
      if(t === "light") return "‚ú®";
      if(t === "spicy") return "üïØÔ∏è";
      return "‚Ä¢";
    }

    function renderCard(isNext=false){
      renderScores();
      renderSpice();
      renderProgress();

      const q = currentQuestion();
      if(!q){
        els.qIndex.textContent = "Ready?";
        els.pointsPill.textContent = "‚Äî";
        els.preface.textContent = "Keep it light and sweet.";
        els.qText.textContent = "Tap ‚ÄúNext‚Äù to start.";
        els.meta.innerHTML = "";
        els.addH.textContent = "+ points to Holly";
        els.addB.textContent = "+ points to Bailey";
        setMascotMood(["light"]);
        return;
      }

      const pool = filteredQuestions();
      const idxInPool = pool.findIndex(x => x.id === q.id);
      els.qIndex.textContent = `Card ${idxInPool + 1}`;
      els.pointsPill.textContent = `${q.pts} pts`;
      els.qText.textContent = q.q;

      const tags = q.tags || [];
      els.preface.textContent = prefaceFor(tags);
      setMascotMood(tags);

      els.meta.innerHTML = "";
      tags.forEach(t => {
        const span = document.createElement("span");
        span.className = "tag";
        span.textContent = `${tagEmoji(t)} ${t}`;
        els.meta.appendChild(span);
      });

      els.addH.textContent = `+${q.pts} to Holly`;
      els.addB.textContent = `+${q.pts} to Bailey`;

      if(isNext){
        mascotPop();
        emojiPop("next");
      }
    }

    function mascotPop(){
      els.mascot.classList.add("pop");
      setTimeout(() => els.mascot.classList.remove("pop"), 260);
    }

    function emojiPop(context){
      const rect = els.poplayer.getBoundingClientRect();

      const x = rect.width * (context === "H" ? 0.30 : context === "B" ? 0.70 : 0.50);
      const y = rect.height * (context === "next" ? 0.22 : 0.34);

      const choices =
        context === "undo" ? ["‚ú®","‚≠ê"] :
        context === "next" ? ["‚≠ê","‚ú®"] :
        ["‚ú®","‚≠ê","üïØÔ∏è","ü´∂"];

      const count = 1; // calm: single pop only

      for(let i=0;i<count;i++){
        const el = document.createElement("div");
        el.className = "emopop";
        el.textContent = choices[Math.floor(Math.random()*choices.length)];
        const jitterX = (Math.random()*18 - 9);
        const jitterY = (Math.random()*10 - 5);
        el.style.left = (x + jitterX) + "px";
        el.style.top = (y + jitterY) + "px";
        els.poplayer.appendChild(el);
        setTimeout(() => el.remove(), 750);
      }
    }

    function resetAll(){
      const keepSpice = state.includeSpicy;
      state = structuredClone(defaultState);
      state.includeSpicy = keepSpice;
      saveState();
      renderCard();
    }

    function toggleSpicy(){
      state.includeSpicy = !state.includeSpicy;
      // reset deck so filter changes cleanly
      state.currentId = null;
      state.usedIds = [];
      state.lastAction = null;
      saveState();
      renderCard();
      emojiPop("next");
      mascotPop();
    }

    // Events
    els.next.addEventListener("click", pickNext);
    els.skip.addEventListener("click", pickNext); // ‚úÖ skip now works (same as next)
    els.addH.addEventListener("click", () => award("H"));
    els.addB.addEventListener("click", () => award("B"));
    els.undo.addEventListener("click", undo);

    els.spiceSwitch.addEventListener("click", toggleSpicy);
    els.spiceSwitch.addEventListener("keydown", (e) => {
      if(e.key === "Enter" || e.key === " "){
        e.preventDefault();
        toggleSpicy();
      }
    });

    els.resetAll.addEventListener("click", () => {
      const ok = confirm("Reset scores + progress? (You can‚Äôt undo this)");
      if(ok) resetAll();
    });

    // Init
    saveState();
    renderCard();
  </script>
</body>
</html>
